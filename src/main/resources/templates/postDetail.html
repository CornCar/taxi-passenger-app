<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>게시글 상세 보기</title>

  <!-- ✅ Tmap 지도 스크립트 -->
  <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0"></script>

  <!-- ✅ Kakao 주소 → 좌표 변환용 스크립트 (지오코딩용) -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5785ff36be13888f3f627611b39b95d7&libraries=services"></script>

  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<h1>게시글 상세</h1>

<div>
  <p><strong>출발지:</strong> <span th:text="${post.departure}"></span></p>
  <p><strong>도착지:</strong> <span th:text="${post.destination}"></span></p>
  <p><strong>출발 시각:</strong> <span th:text="${post.departureTime}"></span></p>
  <p><strong>예상 요금:</strong> <span id="fare"></span>원</p>
  <p><strong>예상 소요 시간:</strong> <span id="time"></span></p>
</div>

<div id="map"></div>

<script th:inline="javascript">
  // 출발지: DB에서 위도/경도 직접 받기
  const startLat = /*[[${post.departureLat}]]*/ 37.5665;
  const startLon = /*[[${post.departureLon}]]*/ 126.9780;

  // 도착지 주소는 그대로 사용
  const destinationAddr = /*[[${post.destination}]]*/ '서울특별시 중구 세종대로 110';

  const tmapKey = 'L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0';

  const map = new Tmapv2.Map("map", {
    center: new Tmapv2.LatLng(startLat, startLon),
    width: "100%",
    height: "400px",
    zoom: 15
  });

  const geocoder = new kakao.maps.services.Geocoder();

  let endLat, endLon;

  // 도착지만 주소 → 좌표 변환
  geocoder.addressSearch(destinationAddr, function(result, status) {
    if (status === kakao.maps.services.Status.OK) {
      endLat = result[0].y;
      endLon = result[0].x;

      getTmapRoute(startLon, startLat, endLon, endLat);
    } else {
      console.warn("도착지 좌표 변환 실패");
    }
  });

  function getTmapRoute(startX, startY, endX, endY) {
    fetch("https://apis.openapi.sk.com/tmap/routes?version=1", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "appKey": tmapKey
      },
      body: JSON.stringify({
        startX: startX,
        startY: startY,
        endX: endX,
        endY: endY,
        reqCoordType: "WGS84GEO",
        resCoordType: "WGS84GEO",
        searchOption: 0
      })
    })
            .then(res => res.json())
            .then(data => {
              const result = data.features;
              const path = [];

              result.forEach(feature => {
                const coords = feature.geometry.coordinates;
                if (feature.geometry.type === "LineString") {
                  coords.forEach(coord => {
                    path.push(new Tmapv2.LatLng(coord[1], coord[0]));
                  });
                }
              });

              new Tmapv2.Polyline({
                path: path,
                strokeColor: "#FF0000",
                strokeWeight: 4,
                map: map
              });

              map.setCenter(path[0]);

              const properties = result[0].properties;
              document.getElementById('fare').textContent = properties.taxiFare;
              const minutes = Math.round(properties.totalTime / 60);
              document.getElementById('time').textContent = `${minutes}분`;
            });
  }
</script>

</body>
</html>