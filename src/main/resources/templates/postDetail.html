<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>게시글 상세 보기</title>

  <!-- ✅ Tmap 지도 스크립트 -->
  <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0"></script>

  <!-- ✅ Kakao 주소 → 좌표 변환용 스크립트 (지오코딩용) -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5785ff36be13888f3f627611b39b95d7&libraries=services"></script>

  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="container mt-5 p-4 bg-white shadow rounded" style="max-width: 800px;">
  <h1 class="mb-4 fw-bold">게시글 상세</h1>

  <p><strong>출발지:</strong> <span th:text="${post.departure}"></span></p>
  <p><strong>도착지:</strong> <span th:text="${post.destination}"></span></p>
  <p><strong>출발 시각:</strong> <span th:text="${post.departureTime}"></span></p>
  <p><strong>예상 요금:</strong> <span id="fare"></span>원</p>
  <p><strong>예상 소요 시간:</strong> <span id="time"></span></p>

    <button class="btn btn-success btn-sm"
            th:onclick="'joinPost(' + ${post.id} + ')'"
            th:disabled="${post.participants.size() >= 4}">
      참여
    </button>
  <p th:text="${post.participants.size()} + ' / 4'">[ 0 / 4 ] 명</p>
  <h2>참여자 명단</h2>
  <ul>
    <th:block th:each="participant : ${participants}">
      <li th:text="${participant.member.id}"></li>
    </th:block>
  </ul>

  <div id="map" class="my-4" style="height: 400px; border-radius: 10px; overflow: hidden;"></div>

  <!-- 돌아가기 버튼 -->
  <div class="text-center">
    <a href="/api/taxi-posts/postList" class="btn btn-outline-primary px-4 py-2 rounded-pill">
      ← 목록으로 돌아가기
    </a>
  </div>
</div>

<script th:inline="javascript">
  const startLat = /*[[${post.departureLat}]]*/ 37.5665;
  const startLon = /*[[${post.departureLon}]]*/ 126.9780;

  // ✅ 도착지도 DB에 저장된 위/경도 사용
  const endLat = /*[[${post.destinationLat}]]*/ 35.11469;
  const endLon = /*[[${post.destinationLon}]]*/ 128.9665;

  const tmapKey = 'L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0';

  const map = new Tmapv2.Map("map", {
    center: new Tmapv2.LatLng(startLat, startLon),
    width: "100%",
    height: "400px",
    zoom: 15
  });

  getTmapRoute(startLon, startLat, endLon, endLat);

  function getTmapRoute(startX, startY, endX, endY) {
    fetch("https://apis.openapi.sk.com/tmap/routes?version=1", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "appKey": tmapKey
      },
      body: JSON.stringify({
        startX, startY, endX, endY,
        reqCoordType: "WGS84GEO",
        resCoordType: "WGS84GEO",
        searchOption: 0
      })
    })
            .then(res => res.json())
            .then(data => {
              const result = data.features;
              const path = [];

              result.forEach(feature => {
                if (feature.geometry.type === "LineString") {
                  feature.geometry.coordinates.forEach(coord => {
                    path.push(new Tmapv2.LatLng(coord[1], coord[0]));
                  });
                }
              });

              new Tmapv2.Polyline({
                path: path,
                strokeColor: "#FF0000",
                strokeWeight: 4,
                map: map
              });

              map.setCenter(path[0]);

              const properties = result[0].properties;
              document.getElementById('fare').textContent = properties.taxiFare;
              const minutes = Math.round(properties.totalTime / 60);
              document.getElementById('time').textContent = `${minutes}분`;
            });
  }
</script>